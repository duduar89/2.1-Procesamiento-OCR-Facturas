# 📄 MÓDULO FACTURAS & ALBARANES - RESUMEN COMPLETO

## 🎯 OBJETIVO PRINCIPAL
Crear un sistema profesional de gestión de facturas y albaranes que mantenga tu funcionalidad actual de drag & drop y añada visualización potente con overlays PDF y análisis de costos.

---

## 🏗️ ARQUITECTURA GENERAL

### **BASE ACTUAL (Mantener):**
- ✅ Tu `index.html` con drag & drop
- ✅ Tu Edge Function de procesamiento  
- ✅ Conexión con Supabase y Document AI
- ✅ Tablas: `proveedores`, `productos_maestro`, `datos_extraidos_facturas`

### **MEJORAS A IMPLEMENTAR:**
- 📊 Dashboard con métricas de costos
- 📋 Lista profesional de facturas
- 👁️ Modal con PDF + overlays de confianza
- 🔄 Sistema de cotejación automática

---

## 📊 DASHBOARD PRINCIPAL

### **MÉTRICAS CLAVE (4 tarjetas superiores):**
```
┌─ GASTO TOTAL ──────┐ ┌─ COGS REAL ───┐ ┌─ GASTOS FIJOS ─┐ ┌─ ALERTAS ─────┐
│ 15.420€            │ │ 32.1%         │ │ 15% sobre neto │ │ 🔴 3 críticas │
│ 📈 +12% vs mes ant │ │ Teórico: 34%  │ │ 2.310€/mes     │ │ 🟡 5 avisos   │
│ 📊 +8% vs año ant  │ │ 📉 -2.1% ideal│ │ Alquiler ✅    │ │ 🔍 Ver todas  │
└────────────────────┘ └───────────────┘ └────────────────┘ └───────────────┘
```

### **ZONA DRAG & DROP (Tu funcional actual + diseño mejorado):**
```
┌─────────────────────────────────────────────────────────┐
│ [📤 + Subir Nueva Factura/Albarán]  [🔍 Filtros]       │
│                                                         │
│ 📄 Arrastra documentos aquí o haz click para seleccionar│
│ Formatos: PDF, JPG, PNG | Máximo: 10MB                 │
└─────────────────────────────────────────────────────────┘
```

---

## 📋 LISTA DE DOCUMENTOS

### **TABLA PROFESIONAL:**
```
┌─────────────────────────────────────────────────────────────┐
│ Estado │ Tipo    │ #Doc  │ Proveedor     │ Fecha │ Importe │ Acciones │
├────────┼─────────┼───────┼───────────────┼───────┼─────────┼──────────┤
│ ✅     │ Factura │ 1301  │ MADACO SL     │ 12/11 │ 1.534€  │ 👁️ 🔗   │
│ ⚠️     │ Factura │ 1302  │ DISTRIBUC...  │ 13/11 │ 2.156€  │ 👁️ 🔗   │
│ 🔄     │ Albarán │ 2528  │ MADACO SL     │ 12/11 │   ---   │ 👁️ 🔍   │
│ ❌     │ Factura │ ERROR │ OCR FAILED    │ 14/11 │   ---   │ 🔧 🗑️   │
└─────────────────────────────────────────────────────────────┘
```

### **ESTADOS:**
- ✅ **Verde**: Procesado y validado correctamente
- ⚠️ **Amarillo**: Requiere revisión manual (confianza media)
- 🔄 **Azul**: Albarán pendiente de factura
- ❌ **Rojo**: Error en procesamiento o baja confianza

### **TIPOS:**
- 📄 **Factura**: Documento fiscal con importes
- 📋 **Albarán**: Documento de entrega (puede tener o no precios)

---

## 👁️ MODAL VISOR CON OVERLAYS (LO MÁS IMPORTANTE)

### **DISEÑO DUAL:**
```
┌───────────────────────────────────────────────────────────────┐
│ 📄 Factura #1301 - MADACO 2019, S.L.U.    [< >] [💾] [×]    │
├─────────────────────────┬─────────────────────────────────────┤
│                         │ 📋 DATOS EXTRAÍDOS                 │
│   📄 PDF ORIGINAL       │                                     │
│                         │ ┌─ 🏢 PROVEEDOR ─────────────────┐ │
│   [Documento con        │ │ ✅ Nombre: MADACO 2019, S.L.U. │ │
│    overlays de          │ │ ⚠️ CIF: B10824431   [70%] [✏️] │ │
│    confianza en         │ │ ✅ Dirección: CL GESSAMÍ...     │ │
│    tiempo real]         │ └─────────────────────────────────┘ │
│                         │                                     │
│ 🔍 CONTROLES:           │ ┌─ 📄 DATOS FISCALES ─────────────┐ │
│ [🔍-] [🔍+] [📱 Fit]   │ │ ✅ Número: 1301        [85%]    │ │
│ [🔄 Rotar] [📄 Páginas]│ │ ✅ Fecha: 12/11/2024   [92%]    │ │
│                         │ │ ❌ Vencimiento: (vacío) [0%][✏️]│ │
│                         │ └─────────────────────────────────┘ │
│                         │                                     │
│                         │ ┌─ 💰 IMPORTES ───────────────────┐ │
│                         │ │ ✅ Total: 1.534,39€    [98%]    │ │
│                         │ │ ✅ Base: 1.387,40€     [88%]    │ │
│                         │ │ ✅ IVA: 147,00€ (21%)  [85%]    │ │
│                         │ └─────────────────────────────────┘ │
└─────────────────────────┴─────────────────────────────────────┘
```

### **SISTEMA DE OVERLAYS:**
- **🟢 Verde (>90%)**: Campo detectado con alta confianza
- **🟡 Amarillo (70-90%)**: Campo detectado, requiere verificación  
- **🔴 Rojo (<70%)**: Campo mal detectado, requiere corrección manual
- **📍 Click en overlay** → Cursor salta al campo en el formulario
- **✏️ Edición inline** → Click para corregir valores
- **💾 Auto-guardado** → Cambios se guardan automáticamente

---

## 🔄 SISTEMA DE COTEJACIÓN

### **ALBARANES → FACTURAS:**
- **Detección automática** por número de albarán en facturas
- **Matching por proveedor** y fechas aproximadas
- **Alertas** de albaranes sin factura después de X días
- **Estado visual** en la lista (🔄 = pendiente de facturar)

### **FACTURAS → PAGOS BANCARIOS:**
- **Cotejación** con movimientos bancarios (futuro)
- **Estados de pago** (pendiente/pagado/vencido)
- **Alertas de vencimientos**

---

## 📊 ANÁLISIS DE COSTOS

### **COGS TEÓRICO vs REAL:**
- **Teórico**: Lo comprado según facturas
- **Real**: Lo vendido según sistema de ventas
- **Diferencias**: Mermas, desperdicios, robos detectados

### **GASTOS POR PROVEEDOR:**
- **Ranking** de proveedores por gasto
- **Evolución** mensual por proveedor
- **% peso** sobre total de gastos
- **Comparativas** mes anterior/año anterior

### **GASTOS FIJOS:**
- **Identificación automática** de facturas recurrentes
- **Control** de que lleguen todos los meses
- **Alertas** si cambian importes inesperadamente
- **% sobre ventas** con límites configurables

### **LÍMITES Y ALERTAS:**
- **Por proveedor**: "No gastar más de X€/mes en MADACO"
- **Por categoría**: "Carnes no superar Y€/mes"  
- **Globales**: "COGS no superar 35%"
- **Notificaciones** cuando se acercan a límites

---

## 🚀 FLUJO COMPLETO DE USUARIO

### **1. SUBIDA Y PROCESAMIENTO:**
1. Usuario arrastra factura/albarán → Validation + upload
2. Document AI procesa automáticamente → OCR + extracción
3. Aparece en lista con estado según confianza
4. Sistema busca automáticamente cotejaciones

### **2. REVISIÓN Y CORRECCIÓN:**
1. Click "👁️ Ver" → Modal se abre con PDF + datos
2. Overlays muestran confianza por colores
3. Click en overlay rojo → Campo se selecciona para edición  
4. Usuario corrige → Auto-guardado + overlay cambia a verde
5. Todos campos verdes → Documento marcado como validado

### **3. ANÁLISIS Y CONTROL:**
1. Dashboard muestra métricas actualizadas en tiempo real
2. Alertas aparecen cuando se superan límites
3. Históricos y comparativas disponibles
4. Cotejación automática con albaranes relacionados

---

## 📁 ESTRUCTURA DE ARCHIVOS

### **FRONTEND:**
```
/proyecto/
├── index.html                     # Dashboard principal (MEJORAR)
├── app.js                         # Lógica principal (AMPLIAR)
├── style.css                      # Estilos (MODERNIZAR)
├── factura-viewer.js              # Modal con PDF + overlays (NUEVO)
├── dashboard-metrics.js           # Cálculo de métricas (NUEVO)
└── cotejacion.js                  # Lógica cotejación (NUEVO)
```

### **BACKEND (Edge Functions):**
```
/supabase/functions/
├── process-document/              # Tu función actual (MANTENER)
├── get-factura-data/              # API para modal (NUEVO)
├── update-campo-factura/          # Guardar correcciones (NUEVO)
├── calculate-metrics/             # Calcular KPIs (NUEVO)
└── cotejacion-automatica/         # Matching documentos (NUEVO)
```

---

## 🎯 PLAN DE IMPLEMENTACIÓN

### **🔥 FASE 1 - BASE VISUAL (Semana 1):**
- [ ] Mejorar tu `index.html` con dashboard moderno
- [ ] Lista profesional de facturas
- [ ] Modal básico con PDF viewer
- [ ] 4 métricas principales

### **📄 FASE 2 - OVERLAYS Y EDICIÓN (Semana 2):**
- [ ] Sistema de overlays con PDF.js
- [ ] Edición inline de campos
- [ ] Auto-guardado de correcciones
- [ ] Navegación entre documentos

### **🔄 FASE 3 - COTEJACIÓN (Semana 3):**
- [ ] Detección automática albarán→factura
- [ ] Estados visuales de cotejación
- [ ] Alertas de documentos pendientes
- [ ] Métricas de COGS teórico vs real

### **📊 FASE 4 - ANÁLISIS AVANZADO (Semana 4):**
- [ ] Sistema de límites por proveedor/categoría
- [ ] Alertas inteligentes
- [ ] Históricos y comparativas
- [ ] Exportación de reportes

---

## 💎 RESULTADO FINAL

### **LO QUE TENDRÁS:**
- ✅ **Sistema completo** de gestión de facturas y albaranes
- ✅ **Visualización profesional** con PDF + overlays
- ✅ **Control total** de costos y COGS
- ✅ **Cotejación automática** entre documentos
- ✅ **Alertas inteligentes** para control de gastos
- ✅ **Dashboard ejecutivo** con métricas clave

### **BENEFICIOS:**
- 🚀 **Ahorro de tiempo**: 80% menos revisión manual
- 💰 **Control de costos**: Alertas antes de superar límites  
- 📊 **Visibilidad total**: Saber exactamente dónde va cada euro
- 🔍 **Trazabilidad**: Desde albarán hasta pago bancario
- ⚡ **Escalabilidad**: Sistema crece con tu negocio

---

**🎯 Prioridad:** MÁXIMA - Es el corazón del control de costos  
**⏱️ Tiempo estimado:** 4 semanas de desarrollo iterativo  
**🏆 ROI esperado:** Ahorro del 15-20% en costos por mejor control