# ğŸ“„ MÃ“DULO FACTURAS & ALBARANES - RESUMEN COMPLETO

## ğŸ¯ OBJETIVO PRINCIPAL
Crear un sistema profesional de gestiÃ³n de facturas y albaranes que mantenga tu funcionalidad actual de drag & drop y aÃ±ada visualizaciÃ³n potente con overlays PDF y anÃ¡lisis de costos.

---

## ğŸ—ï¸ ARQUITECTURA GENERAL

### **BASE ACTUAL (Mantener):**
- âœ… Tu `index.html` con drag & drop
- âœ… Tu Edge Function de procesamiento  
- âœ… ConexiÃ³n con Supabase y Document AI
- âœ… Tablas: `proveedores`, `productos_maestro`, `datos_extraidos_facturas`

### **MEJORAS A IMPLEMENTAR:**
- ğŸ“Š Dashboard con mÃ©tricas de costos
- ğŸ“‹ Lista profesional de facturas
- ğŸ‘ï¸ Modal con PDF + overlays de confianza
- ğŸ”„ Sistema de cotejaciÃ³n automÃ¡tica

---

## ğŸ“Š DASHBOARD PRINCIPAL

### **MÃ‰TRICAS CLAVE (4 tarjetas superiores):**
```
â”Œâ”€ GASTO TOTAL â”€â”€â”€â”€â”€â”€â” â”Œâ”€ COGS REAL â”€â”€â”€â” â”Œâ”€ GASTOS FIJOS â”€â” â”Œâ”€ ALERTAS â”€â”€â”€â”€â”€â”
â”‚ 15.420â‚¬            â”‚ â”‚ 32.1%         â”‚ â”‚ 15% sobre neto â”‚ â”‚ ğŸ”´ 3 crÃ­ticas â”‚
â”‚ ğŸ“ˆ +12% vs mes ant â”‚ â”‚ TeÃ³rico: 34%  â”‚ â”‚ 2.310â‚¬/mes     â”‚ â”‚ ğŸŸ¡ 5 avisos   â”‚
â”‚ ğŸ“Š +8% vs aÃ±o ant  â”‚ â”‚ ğŸ“‰ -2.1% idealâ”‚ â”‚ Alquiler âœ…    â”‚ â”‚ ğŸ” Ver todas  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **ZONA DRAG & DROP (Tu funcional actual + diseÃ±o mejorado):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [ğŸ“¤ + Subir Nueva Factura/AlbarÃ¡n]  [ğŸ” Filtros]       â”‚
â”‚                                                         â”‚
â”‚ ğŸ“„ Arrastra documentos aquÃ­ o haz click para seleccionarâ”‚
â”‚ Formatos: PDF, JPG, PNG | MÃ¡ximo: 10MB                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ LISTA DE DOCUMENTOS

### **TABLA PROFESIONAL:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Estado â”‚ Tipo    â”‚ #Doc  â”‚ Proveedor     â”‚ Fecha â”‚ Importe â”‚ Acciones â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ…     â”‚ Factura â”‚ 1301  â”‚ MADACO SL     â”‚ 12/11 â”‚ 1.534â‚¬  â”‚ ğŸ‘ï¸ ğŸ”—   â”‚
â”‚ âš ï¸     â”‚ Factura â”‚ 1302  â”‚ DISTRIBUC...  â”‚ 13/11 â”‚ 2.156â‚¬  â”‚ ğŸ‘ï¸ ğŸ”—   â”‚
â”‚ ğŸ”„     â”‚ AlbarÃ¡n â”‚ 2528  â”‚ MADACO SL     â”‚ 12/11 â”‚   ---   â”‚ ğŸ‘ï¸ ğŸ”   â”‚
â”‚ âŒ     â”‚ Factura â”‚ ERROR â”‚ OCR FAILED    â”‚ 14/11 â”‚   ---   â”‚ ğŸ”§ ğŸ—‘ï¸   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **ESTADOS:**
- âœ… **Verde**: Procesado y validado correctamente
- âš ï¸ **Amarillo**: Requiere revisiÃ³n manual (confianza media)
- ğŸ”„ **Azul**: AlbarÃ¡n pendiente de factura
- âŒ **Rojo**: Error en procesamiento o baja confianza

### **TIPOS:**
- ğŸ“„ **Factura**: Documento fiscal con importes
- ğŸ“‹ **AlbarÃ¡n**: Documento de entrega (puede tener o no precios)

---

## ğŸ‘ï¸ MODAL VISOR CON OVERLAYS (LO MÃS IMPORTANTE)

### **DISEÃ‘O DUAL:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“„ Factura #1301 - MADACO 2019, S.L.U.    [< >] [ğŸ’¾] [Ã—]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                         â”‚ ğŸ“‹ DATOS EXTRAÃDOS                 â”‚
â”‚   ğŸ“„ PDF ORIGINAL       â”‚                                     â”‚
â”‚                         â”‚ â”Œâ”€ ğŸ¢ PROVEEDOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   [Documento con        â”‚ â”‚ âœ… Nombre: MADACO 2019, S.L.U. â”‚ â”‚
â”‚    overlays de          â”‚ â”‚ âš ï¸ CIF: B10824431   [70%] [âœï¸] â”‚ â”‚
â”‚    confianza en         â”‚ â”‚ âœ… DirecciÃ³n: CL GESSAMÃ...     â”‚ â”‚
â”‚    tiempo real]         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚                                     â”‚
â”‚ ğŸ” CONTROLES:           â”‚ â”Œâ”€ ğŸ“„ DATOS FISCALES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ [ğŸ”-] [ğŸ”+] [ğŸ“± Fit]   â”‚ â”‚ âœ… NÃºmero: 1301        [85%]    â”‚ â”‚
â”‚ [ğŸ”„ Rotar] [ğŸ“„ PÃ¡ginas]â”‚ â”‚ âœ… Fecha: 12/11/2024   [92%]    â”‚ â”‚
â”‚                         â”‚ â”‚ âŒ Vencimiento: (vacÃ­o) [0%][âœï¸]â”‚ â”‚
â”‚                         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚                                     â”‚
â”‚                         â”‚ â”Œâ”€ ğŸ’° IMPORTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                         â”‚ â”‚ âœ… Total: 1.534,39â‚¬    [98%]    â”‚ â”‚
â”‚                         â”‚ â”‚ âœ… Base: 1.387,40â‚¬     [88%]    â”‚ â”‚
â”‚                         â”‚ â”‚ âœ… IVA: 147,00â‚¬ (21%)  [85%]    â”‚ â”‚
â”‚                         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **SISTEMA DE OVERLAYS:**
- **ğŸŸ¢ Verde (>90%)**: Campo detectado con alta confianza
- **ğŸŸ¡ Amarillo (70-90%)**: Campo detectado, requiere verificaciÃ³n  
- **ğŸ”´ Rojo (<70%)**: Campo mal detectado, requiere correcciÃ³n manual
- **ğŸ“ Click en overlay** â†’ Cursor salta al campo en el formulario
- **âœï¸ EdiciÃ³n inline** â†’ Click para corregir valores
- **ğŸ’¾ Auto-guardado** â†’ Cambios se guardan automÃ¡ticamente

---

## ğŸ”„ SISTEMA DE COTEJACIÃ“N

### **ALBARANES â†’ FACTURAS:**
- **DetecciÃ³n automÃ¡tica** por nÃºmero de albarÃ¡n en facturas
- **Matching por proveedor** y fechas aproximadas
- **Alertas** de albaranes sin factura despuÃ©s de X dÃ­as
- **Estado visual** en la lista (ğŸ”„ = pendiente de facturar)

### **FACTURAS â†’ PAGOS BANCARIOS:**
- **CotejaciÃ³n** con movimientos bancarios (futuro)
- **Estados de pago** (pendiente/pagado/vencido)
- **Alertas de vencimientos**

---

## ğŸ“Š ANÃLISIS DE COSTOS

### **COGS TEÃ“RICO vs REAL:**
- **TeÃ³rico**: Lo comprado segÃºn facturas
- **Real**: Lo vendido segÃºn sistema de ventas
- **Diferencias**: Mermas, desperdicios, robos detectados

### **GASTOS POR PROVEEDOR:**
- **Ranking** de proveedores por gasto
- **EvoluciÃ³n** mensual por proveedor
- **% peso** sobre total de gastos
- **Comparativas** mes anterior/aÃ±o anterior

### **GASTOS FIJOS:**
- **IdentificaciÃ³n automÃ¡tica** de facturas recurrentes
- **Control** de que lleguen todos los meses
- **Alertas** si cambian importes inesperadamente
- **% sobre ventas** con lÃ­mites configurables

### **LÃMITES Y ALERTAS:**
- **Por proveedor**: "No gastar mÃ¡s de Xâ‚¬/mes en MADACO"
- **Por categorÃ­a**: "Carnes no superar Yâ‚¬/mes"  
- **Globales**: "COGS no superar 35%"
- **Notificaciones** cuando se acercan a lÃ­mites

---

## ğŸš€ FLUJO COMPLETO DE USUARIO

### **1. SUBIDA Y PROCESAMIENTO:**
1. Usuario arrastra factura/albarÃ¡n â†’ Validation + upload
2. Document AI procesa automÃ¡ticamente â†’ OCR + extracciÃ³n
3. Aparece en lista con estado segÃºn confianza
4. Sistema busca automÃ¡ticamente cotejaciones

### **2. REVISIÃ“N Y CORRECCIÃ“N:**
1. Click "ğŸ‘ï¸ Ver" â†’ Modal se abre con PDF + datos
2. Overlays muestran confianza por colores
3. Click en overlay rojo â†’ Campo se selecciona para ediciÃ³n  
4. Usuario corrige â†’ Auto-guardado + overlay cambia a verde
5. Todos campos verdes â†’ Documento marcado como validado

### **3. ANÃLISIS Y CONTROL:**
1. Dashboard muestra mÃ©tricas actualizadas en tiempo real
2. Alertas aparecen cuando se superan lÃ­mites
3. HistÃ³ricos y comparativas disponibles
4. CotejaciÃ³n automÃ¡tica con albaranes relacionados

---

## ğŸ“ ESTRUCTURA DE ARCHIVOS

### **FRONTEND:**
```
/proyecto/
â”œâ”€â”€ index.html                     # Dashboard principal (MEJORAR)
â”œâ”€â”€ app.js                         # LÃ³gica principal (AMPLIAR)
â”œâ”€â”€ style.css                      # Estilos (MODERNIZAR)
â”œâ”€â”€ factura-viewer.js              # Modal con PDF + overlays (NUEVO)
â”œâ”€â”€ dashboard-metrics.js           # CÃ¡lculo de mÃ©tricas (NUEVO)
â””â”€â”€ cotejacion.js                  # LÃ³gica cotejaciÃ³n (NUEVO)
```

### **BACKEND (Edge Functions):**
```
/supabase/functions/
â”œâ”€â”€ process-document/              # Tu funciÃ³n actual (MANTENER)
â”œâ”€â”€ get-factura-data/              # API para modal (NUEVO)
â”œâ”€â”€ update-campo-factura/          # Guardar correcciones (NUEVO)
â”œâ”€â”€ calculate-metrics/             # Calcular KPIs (NUEVO)
â””â”€â”€ cotejacion-automatica/         # Matching documentos (NUEVO)
```

---

## ğŸ¯ PLAN DE IMPLEMENTACIÃ“N

### **ğŸ”¥ FASE 1 - BASE VISUAL (Semana 1):**
- [ ] Mejorar tu `index.html` con dashboard moderno
- [ ] Lista profesional de facturas
- [ ] Modal bÃ¡sico con PDF viewer
- [ ] 4 mÃ©tricas principales

### **ğŸ“„ FASE 2 - OVERLAYS Y EDICIÃ“N (Semana 2):**
- [ ] Sistema de overlays con PDF.js
- [ ] EdiciÃ³n inline de campos
- [ ] Auto-guardado de correcciones
- [ ] NavegaciÃ³n entre documentos

### **ğŸ”„ FASE 3 - COTEJACIÃ“N (Semana 3):**
- [ ] DetecciÃ³n automÃ¡tica albarÃ¡nâ†’factura
- [ ] Estados visuales de cotejaciÃ³n
- [ ] Alertas de documentos pendientes
- [ ] MÃ©tricas de COGS teÃ³rico vs real

### **ğŸ“Š FASE 4 - ANÃLISIS AVANZADO (Semana 4):**
- [ ] Sistema de lÃ­mites por proveedor/categorÃ­a
- [ ] Alertas inteligentes
- [ ] HistÃ³ricos y comparativas
- [ ] ExportaciÃ³n de reportes

---

## ğŸ’ RESULTADO FINAL

### **LO QUE TENDRÃS:**
- âœ… **Sistema completo** de gestiÃ³n de facturas y albaranes
- âœ… **VisualizaciÃ³n profesional** con PDF + overlays
- âœ… **Control total** de costos y COGS
- âœ… **CotejaciÃ³n automÃ¡tica** entre documentos
- âœ… **Alertas inteligentes** para control de gastos
- âœ… **Dashboard ejecutivo** con mÃ©tricas clave

### **BENEFICIOS:**
- ğŸš€ **Ahorro de tiempo**: 80% menos revisiÃ³n manual
- ğŸ’° **Control de costos**: Alertas antes de superar lÃ­mites  
- ğŸ“Š **Visibilidad total**: Saber exactamente dÃ³nde va cada euro
- ğŸ” **Trazabilidad**: Desde albarÃ¡n hasta pago bancario
- âš¡ **Escalabilidad**: Sistema crece con tu negocio

---

**ğŸ¯ Prioridad:** MÃXIMA - Es el corazÃ³n del control de costos  
**â±ï¸ Tiempo estimado:** 4 semanas de desarrollo iterativo  
**ğŸ† ROI esperado:** Ahorro del 15-20% en costos por mejor control