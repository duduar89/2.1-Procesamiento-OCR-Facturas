<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† Test Gr√°ficos - FacturasIA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 15px;
            text-align: center;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .btn {
            background: #00D4AA;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: #00BFA5;
            transform: translateY(-2px);
        }
        .controls {
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: 500;
        }
        .status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .status.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Test Gr√°ficos - FacturasIA by BrainStormers</h1>
            <p>Prueba de funcionalidad de gr√°ficos con Chart.js</p>
        </div>

        <div class="controls">
            <button class="btn" onclick="testCharts()">üìä Probar Gr√°ficos</button>
            <button class="btn" onclick="clearCharts()">üóëÔ∏è Limpiar Gr√°ficos</button>
            <button class="btn" onclick="testWithMockData()">üé≤ Datos de Ejemplo</button>
        </div>

        <div id="status" class="status info">Listo para probar gr√°ficos</div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title">Gr√°fico de Proveedores (Doughnut)</div>
                <div class="chart-container">
                    <canvas id="proveedorChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Gr√°fico de Categor√≠as (Bar)</div>
                <div class="chart-container">
                    <canvas id="categoriaChart"></canvas>
                </div>
            </div>

            <div class="chart-card" style="grid-column: 1 / -1;">
                <div class="chart-title">Gr√°fico de Evoluci√≥n (Line)</div>
                <div class="chart-container">
                    <canvas id="evolutionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales para los gr√°ficos
        let proveedorChart = null;
        let categoriaChart = null;
        let evolutionChart = null;

        // Funci√≥n para mostrar estado
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        // Funci√≥n para formatear moneda
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR'
            }).format(value);
        }

        // Funci√≥n para probar gr√°ficos
        function testCharts() {
            try {
                showStatus('Probando gr√°ficos...', 'info');
                
                // Verificar que Chart.js est√© disponible
                if (typeof Chart === 'undefined') {
                    throw new Error('Chart.js no est√° disponible');
                }

                // Crear datos de ejemplo
                const mockFacturas = [
                    { proveedor_nombre: 'Proveedor A', total_factura: 1500, fecha_factura: '2024-01-15' },
                    { proveedor_nombre: 'Proveedor B', total_factura: 1200, fecha_factura: '2024-01-16' },
                    { proveedor_nombre: 'Proveedor C', total_factura: 800, fecha_factura: '2024-01-17' },
                    { proveedor_nombre: 'Proveedor D', total_factura: 600, fecha_factura: '2024-01-18' },
                    { proveedor_nombre: 'Proveedor E', total_factura: 400, fecha_factura: '2024-01-19' }
                ];

                // Inicializar gr√°ficos
                initializeCharts(mockFacturas);
                
                showStatus('Gr√°ficos creados exitosamente', 'success');
                
            } catch (error) {
                console.error('Error probando gr√°ficos:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Funci√≥n para limpiar gr√°ficos
        function clearCharts() {
            if (proveedorChart) {
                proveedorChart.destroy();
                proveedorChart = null;
            }
            if (categoriaChart) {
                categoriaChart.destroy();
                categoriaChart = null;
            }
            if (evolutionChart) {
                evolutionChart.destroy();
                evolutionChart = null;
            }
            showStatus('Gr√°ficos limpiados', 'info');
        }

        // Funci√≥n para probar con datos de ejemplo
        function testWithMockData() {
            try {
                showStatus('Generando datos de ejemplo...', 'info');
                
                // Generar datos aleatorios m√°s realistas
                const proveedores = ['Frutas del Sur', 'Carnes Premium', 'L√°cteos Frescos', 'Pescados del Mar', 'Verduras Org√°nicas'];
                const categorias = ['Frutas', 'Carnes', 'L√°cteos', 'Pescados', 'Verduras', 'Condimentos'];
                
                const mockFacturas = [];
                for (let i = 0; i < 50; i++) {
                    const fecha = new Date();
                    fecha.setDate(fecha.getDate() - Math.floor(Math.random() * 30));
                    
                    mockFacturas.push({
                        proveedor_nombre: proveedores[Math.floor(Math.random() * proveedores.length)],
                        total_factura: Math.floor(Math.random() * 2000) + 100,
                        fecha_factura: fecha.toISOString().split('T')[0]
                    });
                }

                initializeCharts(mockFacturas);
                showStatus('Datos de ejemplo generados y gr√°ficos creados', 'success');
                
            } catch (error) {
                console.error('Error con datos de ejemplo:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Funci√≥n para inicializar todos los gr√°ficos
        async function initializeCharts(facturas) {
            try {
                console.log('üìà Inicializando gr√°ficos...');
                console.log('üìä Datos de facturas recibidos:', facturas ? facturas.length : 0);
                
                // Verificar que Chart.js est√© disponible
                if (typeof Chart === 'undefined') {
                    throw new Error('Chart.js no est√° disponible');
                }
                
                console.log('‚úÖ Chart.js disponible, iniciando gr√°ficos...');
                
                // Verificar que los elementos HTML existan
                const proveedorCtx = document.getElementById('proveedorChart');
                const categoriaCtx = document.getElementById('categoriaChart');
                const evolutionCtx = document.getElementById('evolutionChart');
                
                console.log('üîç Elementos HTML encontrados:', {
                    proveedorChart: !!proveedorCtx,
                    categoriaChart: !!categoriaCtx,
                    evolutionChart: !!evolutionCtx
                });
                
                if (!proveedorCtx || !categoriaCtx || !evolutionCtx) {
                    throw new Error('No se encontraron todos los elementos de gr√°ficos');
                }
                
                // Inicializar gr√°ficos uno por uno con manejo de errores individual
                try {
                    await initProveedorChart(facturas);
                    console.log('‚úÖ Gr√°fico de proveedores inicializado');
                } catch (error) {
                    console.error('‚ùå Error en gr√°fico de proveedores:', error);
                }
                
                try {
                    await initCategoriaChart();
                    console.log('‚úÖ Gr√°fico de categor√≠as inicializado');
                } catch (error) {
                    console.error('‚ùå Error en gr√°fico de categor√≠as:', error);
                }
                
                try {
                    await initEvolutionChart(facturas);
                    console.log('‚úÖ Gr√°fico de evoluci√≥n inicializado');
                } catch (error) {
                    console.error('‚ùå Error en gr√°fico de evoluci√≥n:', error);
                }
                
                console.log('‚úÖ Gr√°ficos inicializados correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando gr√°ficos:', error);
                showStatus('Error al cargar los gr√°ficos: ' + error.message, 'error');
            }
        }

        // Gr√°fico de distribuci√≥n por proveedor
        async function initProveedorChart(facturas) {
            try {
                const ctx = document.getElementById('proveedorChart');
                if (!ctx) {
                    console.error('‚ùå Elemento proveedorChart no encontrado');
                    return;
                }
                
                console.log('üìä Inicializando gr√°fico de proveedores con', facturas ? facturas.length : 0, 'facturas');
                
                // Calcular datos
                const proveedorData = {};
                if (facturas && Array.isArray(facturas)) {
                    facturas.forEach(f => {
                        const proveedor = f.proveedor_nombre || 'Sin proveedor';
                        const importe = parseFloat(f.total_factura) || 0;
                        proveedorData[proveedor] = (proveedorData[proveedor] || 0) + importe;
                    });
                }
                
                // Si no hay datos, usar datos de ejemplo
                if (Object.keys(proveedorData).length === 0) {
                    console.log('üìä No hay datos de facturas, usando datos de ejemplo');
                    proveedorData['Proveedor A'] = 1500;
                    proveedorData['Proveedor B'] = 1200;
                    proveedorData['Proveedor C'] = 800;
                    proveedorData['Proveedor D'] = 600;
                    proveedorData['Proveedor E'] = 400;
                }
                
                // Tomar top 10 proveedores
                const sortedProveedores = Object.entries(proveedorData)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10);
                
                const labels = sortedProveedores.map(([proveedor]) => 
                    proveedor.length > 20 ? proveedor.substring(0, 20) + '...' : proveedor
                );
                const data = sortedProveedores.map(([,total]) => total);
                
                console.log('üìä Datos del gr√°fico de proveedores:', { labels, data });
                
                // Crear gr√°fico
                if (proveedorChart) {
                    proveedorChart.destroy();
                }
                
                proveedorChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                '#00D4AA', '#1DE9B6', '#14B8A6', '#10B981', '#26D0CE',
                                '#0F2027', '#2C3E50', '#64748b', '#94a3b8', '#cbd5e1'
                            ],
                            borderWidth: 2,
                            borderColor: '#ffffff',
                            hoverBorderWidth: 3,
                            hoverBorderColor: '#00D4AA'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '60%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    font: {
                                        family: 'Inter',
                                        size: 10,
                                        weight: '500'
                                    },
                                    color: '#64748b'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: '#0F2027',
                                bodyColor: '#64748b',
                                borderColor: '#00D4AA',
                                borderWidth: 1,
                                cornerRadius: 8,
                                displayColors: true,
                                titleFont: {
                                    size: 12
                                },
                                bodyFont: {
                                    size: 11
                                },
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = formatCurrency(context.parsed);
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            animateRotate: true,
                            animateScale: true,
                            duration: 800,
                            easing: 'easeOutQuart'
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico de proveedores creado exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error creando gr√°fico de proveedores:', error);
                throw error;
            }
        }

        // Gr√°fico de categor√≠as
        async function initCategoriaChart() {
            try {
                const ctx = document.getElementById('categoriaChart');
                if (!ctx) {
                    console.error('‚ùå Elemento categoriaChart no encontrado');
                    return;
                }
                
                // Datos de ejemplo para categor√≠as
                const categoriaData = {
                    'General': 15,
                    'Condimentos': 12,
                    'Carnes': 18,
                    'Verduras': 14,
                    'Bebidas': 8,
                    'L√°cteos': 10
                };
                
                const labels = Object.keys(categoriaData);
                const data = Object.values(categoriaData);
                
                if (categoriaChart) {
                    categoriaChart.destroy();
                }
                
                categoriaChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Productos por categor√≠a',
                            data: data,
                            backgroundColor: [
                                '#00D4AA', '#1DE9B6', '#14B8A6', '#10B981', '#26D0CE',
                                '#0F2027', '#2C3E50', '#64748b', '#94a3b8', '#cbd5e1'
                            ],
                            borderColor: '#ffffff',
                            borderWidth: 1,
                            borderRadius: 4,
                            borderSkipped: false,
                            hoverBackgroundColor: [
                                '#00BFA5', '#00D4AA', '#0F766E', '#059669', '#0891b2',
                                '#1e293b', '#334155', '#475569', '#64748b', '#94a3b8'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: '#0F2027',
                                bodyColor: '#64748b',
                                borderColor: '#00D4AA',
                                borderWidth: 1,
                                cornerRadius: 8,
                                displayColors: true,
                                titleFont: {
                                    size: 12
                                },
                                bodyFont: {
                                    size: 11
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#64748b',
                                    font: {
                                        family: 'Inter',
                                        size: 10
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(100, 116, 139, 0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    stepSize: 1,
                                    color: '#64748b',
                                    font: {
                                        family: 'Inter',
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico de categor√≠as creado exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error creando gr√°fico de categor√≠as:', error);
                throw error;
            }
        }

        // Gr√°fico de evoluci√≥n de facturas
        async function initEvolutionChart(facturas) {
            try {
                const ctx = document.getElementById('evolutionChart');
                if (!ctx) {
                    console.error('‚ùå Elemento evolutionChart no encontrado');
                    return;
                }
                
                console.log('üìà Inicializando gr√°fico de evoluci√≥n con', facturas ? facturas.length : 0, 'facturas');
                
                // Generar √∫ltimos 30 d√≠as
                const last30Days = [];
                for (let i = 29; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    last30Days.push(date.toISOString().split('T')[0]);
                }
                
                // Agrupar facturas por d√≠a
                const facturasPorDia = {};
                const importesPorDia = {};
                
                last30Days.forEach(day => {
                    facturasPorDia[day] = 0;
                    importesPorDia[day] = 0;
                });
                
                if (facturas && Array.isArray(facturas)) {
                    facturas.forEach(f => {
                        const day = f.fecha_factura ? f.fecha_factura.split('T')[0] : null;
                        if (day && facturasPorDia.hasOwnProperty(day)) {
                            facturasPorDia[day]++;
                            importesPorDia[day] += parseFloat(f.total_factura) || 0;
                        }
                    });
                }
                
                // Si no hay datos, usar datos de ejemplo
                if (Object.values(facturasPorDia).every(val => val === 0)) {
                    console.log('üìà No hay datos de facturas, usando datos de ejemplo');
                    // Generar datos de ejemplo para los √∫ltimos 30 d√≠as
                    last30Days.forEach((day, index) => {
                        facturasPorDia[day] = Math.floor(Math.random() * 5) + 1;
                        importesPorDia[day] = Math.floor(Math.random() * 1000) + 100;
                    });
                }
                
                const labels = last30Days.map(day => {
                    const date = new Date(day);
                    return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                });
                
                console.log('üìà Datos del gr√°fico de evoluci√≥n:', { 
                    labels: labels.length, 
                    facturas: Object.values(facturasPorDia).slice(0, 5),
                    importes: Object.values(importesPorDia).slice(0, 5)
                });
                
                if (evolutionChart) {
                    evolutionChart.destroy();
                }
                
                evolutionChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'N√∫mero de facturas',
                            data: Object.values(facturasPorDia),
                            borderColor: '#00D4AA',
                            backgroundColor: 'rgba(0, 212, 170, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y',
                            pointBackgroundColor: '#00D4AA',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 1,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            fill: true
                        }, {
                            label: 'Importe total (‚Ç¨)',
                            data: Object.values(importesPorDia),
                            borderColor: '#14B8A6',
                            backgroundColor: 'rgba(20, 184, 166, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1',
                            pointBackgroundColor: '#14B8A6',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 1,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                display: true,
                                grid: {
                                    color: 'rgba(100, 116, 139, 0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#64748b',
                                    font: {
                                        family: 'Inter',
                                        size: 10
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Fecha',
                                    color: '#64748b',
                                    font: {
                                        family: 'Inter',
                                        size: 12,
                                        weight: '600'
                                    }
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                grid: {
                                    color: 'rgba(100, 116, 139, 0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#64748b',
                                    font: {
                                        family: 'Inter',
                                        size: 10
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'N√∫mero de facturas',
                                    color: '#64748b',
                                    font: {
                                        family: 'Inter',
                                        size: 12,
                                        weight: '600'
                                    }
                                },
                                beginAtZero: true
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: {
                                    drawOnChartArea: false,
                                },
                                ticks: {
                                    color: '#64748b',
                                    font: {
                                        family: 'Inter',
                                        size: 10
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Importe (‚Ç¨)',
                                    color: '#64748b',
                                    font: {
                                        family: 'Inter',
                                        size: 12,
                                        weight: '600'
                                    }
                                },
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    usePointStyle: true,
                                    padding: 15,
                                    font: {
                                        family: 'Inter',
                                        size: 10,
                                        weight: '500'
                                    },
                                    color: '#64748b'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: '#0F2027',
                                bodyColor: '#64748b',
                                borderColor: '#00D4AA',
                                borderWidth: 1,
                                cornerRadius: 8,
                                displayColors: true,
                                titleFont: {
                                    size: 12
                                },
                                bodyFont: {
                                    size: 11
                                },
                                callbacks: {
                                    afterBody: function(context) {
                                        const index = context[0].dataIndex;
                                        const fecha = last30Days[index];
                                        return `Fecha: ${fecha}`;
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 800,
                            easing: 'easeOutQuart'
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico de evoluci√≥n creado exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error creando gr√°fico de evoluci√≥n:', error);
                throw error;
            }
        }

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß† Test de Gr√°ficos cargado');
            showStatus('P√°gina cargada. Haz clic en "Probar Gr√°ficos" para comenzar.', 'info');
        });
    </script>
</body>
</html>
