<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Dashboard Debug - Versi√≥n Simplificada</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-panel {
            background: #000;
            color: #0f0;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
            border-radius: 5px;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .warning { color: #ffc107; }
        .dashboard-content {
            border: 2px solid #e9ecef;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            min-height: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Dashboard Debug - Versi√≥n Simplificada</h1>
        <p>Esta es una versi√≥n simplificada del dashboard para identificar qu√© causa el cierre.</p>
        
        <div class="controls">
            <button onclick="loadStep1()">1. Cargar Dependencias</button>
            <button onclick="loadStep2()">2. Inicializar Dashboard</button>
            <button onclick="loadStep3()">3. Cargar Datos</button>
            <button onclick="clearLogs()" style="background: #6c757d;">Limpiar Logs</button>
        </div>
        
        <div id="debug-panel" class="debug-panel"></div>
        
        <div class="dashboard-content" id="dashboard-content">
            <h3>Contenido del Dashboard</h3>
            <p>Aqu√≠ aparecer√° el contenido cuando se cargue correctamente.</p>
        </div>
    </div>

    <!-- Scripts cargados de forma controlada -->
    <script>
        // ===== SISTEMA DE LOGGING PROTEGIDO =====
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const panel = document.getElementById('debug-panel');
            const color = type === 'error' ? '#ff4444' : type === 'warning' ? '#ffaa00' : type === 'success' ? '#44ff44' : '#00ff00';
            panel.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            panel.scrollTop = panel.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        // ===== CAPTURA DE ERRORES GLOBALES =====
        window.addEventListener('error', (event) => {
            log(`‚ùå ERROR GLOBAL: ${event.error?.message || event.message}`, 'error');
            log(`üìÅ Archivo: ${event.filename}:${event.lineno}:${event.colno}`, 'error');
            if (event.error?.stack) {
                log(`üìö Stack: ${event.error.stack}`, 'error');
            }
        });

        window.addEventListener('unhandledrejection', (event) => {
            log(`‚ùå PROMISE REJECTED: ${event.reason}`, 'error');
        });

        window.addEventListener('beforeunload', (event) => {
            log('‚ö†Ô∏è LA VENTANA SE EST√Å CERRANDO!', 'warning');
        });

        // ===== PASOS DE CARGA =====
        
        async function loadStep1() {
            try {
                log('üîç PASO 1: Cargando dependencias...', 'info');
                
                // Cargar Supabase
                if (typeof supabase === 'undefined') {
                    log('üì• Cargando Supabase desde CDN...', 'info');
                    const supabaseScript = document.createElement('script');
                    supabaseScript.src = 'https://unpkg.com/@supabase/supabase-js@2';
                    supabaseScript.onload = () => {
                        log('‚úÖ Supabase cargado correctamente', 'success');
                    };
                    supabaseScript.onerror = () => {
                        log('‚ùå Error cargando Supabase', 'error');
                    };
                    document.head.appendChild(supabaseScript);
                } else {
                    log('‚úÖ Supabase ya est√° cargado', 'success');
                }
                
                // Cargar config.js
                if (typeof CONFIG === 'undefined') {
                    log('üì• Cargando config.js...', 'info');
                    const configScript = document.createElement('script');
                    configScript.src = '../config.js';
                    configScript.onload = () => {
                        log('‚úÖ config.js cargado correctamente', 'success');
                    };
                    configScript.onerror = () => {
                        log('‚ùå Error cargando config.js', 'error');
                    };
                    document.head.appendChild(configScript);
                } else {
                    log('‚úÖ config.js ya est√° cargado', 'success');
                }
                
                log('‚úÖ PASO 1 completado - dependencias cargadas', 'success');
                
            } catch (error) {
                log(`‚ùå Error en PASO 1: ${error.message}`, 'error');
            }
        }

        async function loadStep2() {
            try {
                log('üîç PASO 2: Inicializando dashboard...', 'info');
                
                // Verificar dependencias
                if (typeof CONFIG === 'undefined') {
                    throw new Error('CONFIG no est√° disponible. Ejecuta PASO 1 primero.');
                }
                if (typeof supabase === 'undefined') {
                    throw new Error('Supabase no est√° disponible. Ejecuta PASO 1 primero.');
                }
                
                // Crear cliente Supabase
                const client = supabase.createClient(CONFIG.SUPABASE.URL, CONFIG.SUPABASE.ANON_KEY);
                log('‚úÖ Cliente Supabase creado', 'success');
                
                // Configurar modo desarrollo
                if (window.location.hostname === 'localhost') {
                    log('üîß Configurando modo desarrollo...', 'info');
                    window.currentUser = { id: 'dev-user', nombre: 'Usuario Desarrollo', email: 'dev@test.com' };
                    CONFIG.TENANT.RESTAURANTE_ID = '2852b1af-38d8-43ec-8872-2b2921d5a231';
                    log('‚úÖ Modo desarrollo configurado', 'success');
                }
                
                // Guardar cliente globalmente
                window.supabaseClient = client;
                
                log('‚úÖ PASO 2 completado - dashboard inicializado', 'success');
                
            } catch (error) {
                log(`‚ùå Error en PASO 2: ${error.message}`, 'error');
            }
        }

        async function loadStep3() {
            try {
                log('üîç PASO 3: Cargando datos...', 'info');
                
                if (!window.supabaseClient) {
                    throw new Error('Cliente Supabase no disponible. Ejecuta PASO 2 primero.');
                }
                
                // Cargar facturas
                log('üìä Cargando facturas...', 'info');
                const { data: facturas, error: facturasError } = await window.supabaseClient
                    .from('datos_extraidos_facturas')
                    .select('*')
                    .eq('restaurante_id', CONFIG.TENANT.RESTAURANTE_ID)
                    .order('fecha_extraccion', { ascending: false })
                    .limit(5);
                
                if (facturasError) {
                    log(`‚ö†Ô∏è Error cargando facturas: ${facturasError.message}`, 'warning');
                } else {
                    log(`‚úÖ Facturas cargadas: ${facturas?.length || 0} encontradas`, 'success');
                    
                    // Mostrar datos en el dashboard
                    const content = document.getElementById('dashboard-content');
                    content.innerHTML = `
                        <h3>‚úÖ Dashboard Funcionando</h3>
                        <p><strong>Usuario:</strong> ${window.currentUser?.nombre || 'No definido'}</p>
                        <p><strong>Restaurante ID:</strong> ${CONFIG.TENANT.RESTAURANTE_ID || 'No definido'}</p>
                        <p><strong>Facturas encontradas:</strong> ${facturas?.length || 0}</p>
                        <div style="margin-top: 20px;">
                            <h4>√öltimas facturas:</h4>
                            ${facturas?.map(f => `
                                <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px;">
                                    <strong>${f.numero_factura || 'Sin n√∫mero'}</strong> - 
                                    ${f.proveedor_nombre || 'Sin proveedor'} - 
                                    ${f.fecha_factura || 'Sin fecha'}
                                </div>
                            `).join('') || '<p>No hay facturas</p>'}
                        </div>
                    `;
                }
                
                log('‚úÖ PASO 3 completado - datos cargados', 'success');
                
            } catch (error) {
                log(`‚ùå Error en PASO 3: ${error.message}`, 'error');
            }
        }

        function clearLogs() {
            document.getElementById('debug-panel').innerHTML = '';
            log('üßπ Logs limpiados');
        }

        // ===== INICIALIZACI√ìN =====
        log('üöÄ Dashboard Debug iniciado - ejecuta los pasos en orden');
        
        // Monitor de estabilidad
        setInterval(() => {
            log('üíì Sistema estable');
        }, 10000);
        
    </script>
</body>
</html>
