<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Panel de Cotejo</title>
    <link rel="stylesheet" href="dashboard-facturas.css">
    <style>
        body {
            padding: 20px;
            font-family: 'Inter', sans-serif;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-button {
            background: #00D4AA;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        .test-button:hover {
            background: #00BFA5;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test Panel de Resultados del Cotejo</h1>
        <p>Esta p√°gina permite probar el panel de resultados del cotejo sin necesidad de ejecutar el cotejo real.</p>
        
        <div class="test-buttons">
            <button class="test-button" onclick="testCotejoExitoso()">
                ‚úÖ Test Cotejo Exitoso (Alta Confianza)
            </button>
            
            <button class="test-button" onclick="testCotejoParcial()">
                ‚ö†Ô∏è Test Cotejo Parcial (Media Confianza)
            </button>
            
            <button class="test-button" onclick="testCotejoBajo()">
                ‚ùå Test Cotejo Bajo (Baja Confianza)
            </button>
            
            <button class="test-button" onclick="testCotejoError()">
                üö® Test Cotejo Error
            </button>
        </div>
        
        <div class="test-info">
            <h3>üìã Informaci√≥n del Test:</h3>
            <ul>
                <li><strong>Panel de Resultados:</strong> Se muestra autom√°ticamente al ejecutar el cotejo</li>
                <li><strong>Estado Visual:</strong> Los botones cambian a "‚úÖ Cotejado"</li>
                <li><strong>Indicadores:</strong> Se muestran badges de estado y contadores</li>
                <li><strong>Auto-ocultado:</strong> El panel se oculta autom√°ticamente despu√©s de 10 segundos</li>
            </ul>
        </div>
    </div>

    <script>
        // Simular datos de cotejo exitoso
        function testCotejoExitoso() {
            const resultado = {
                success: true,
                enlaces_automaticos: 3,
                sugerencias: 1,
                requiere_revision: 0,
                notificacion: {
                    tipo: "alta_confianza",
                    mensaje: "‚úÖ COTEJO INVERSO AUTOM√ÅTICO COMPLETADO\n" +
                              " 01 25006320 - TIERRA NUESTRA HUELVA CONSTANTIN BECERRA, S.L.\n" +
                              "üìÑ 3 factura(s) enlazada(s) autom√°ticamente\n" +
                              "üéØ Confianza: 100%",
                    acciones_disponibles: ["ver_enlaces", "revisar_detalles"]
                }
            };
            
            // Simular informaci√≥n del √∫ltimo cotejo
            window.ultimoCotejoEjecutado = {
                documento_id: "9a669245-50ef-4935-939e-1d0038f1c6b7",
                tipo_documento: "albaran",
                timestamp: new Date().toISOString()
            };
            
            mostrarPanelResultadosCotejo(resultado);
            console.log('üß™ Test cotejo exitoso ejecutado');
        }
        
        // Simular datos de cotejo parcial
        function testCotejoParcial() {
            const resultado = {
                success: true,
                enlaces_automaticos: 1,
                sugerencias: 2,
                requiere_revision: 1,
                notificacion: {
                    tipo: "media_confianza",
                    mensaje: "‚ö†Ô∏è COTEJO PARCIAL COMPLETADO\n" +
                              "üìÑ 1 factura enlazada autom√°ticamente\n" +
                              "üí° 2 sugerencias para revisi√≥n manual\n" +
                              "üéØ Confianza: 75%",
                    acciones_disponibles: ["ver_enlaces", "revisar_detalles"]
                }
            };
            
            mostrarPanelResultadosCotejo(resultado);
            console.log('üß™ Test cotejo parcial ejecutado');
        }
        
        // Simular datos de cotejo bajo
        function testCotejoBajo() {
            const resultado = {
                success: true,
                enlaces_automaticos: 0,
                sugerencias: 3,
                requiere_revision: 2,
                notificacion: {
                    tipo: "baja_confianza",
                    mensaje: "‚ùå COTEJO CON BAJA CONFIANZA\n" +
                              "üìÑ 0 facturas enlazadas autom√°ticamente\n" +
                              "üí° 3 sugerencias para revisi√≥n manual\n" +
                              "üéØ Confianza: 45%",
                    acciones_disponibles: ["revisar_detalles", "verificar_id"]
                }
            };
            
            mostrarPanelResultadosCotejo(resultado);
            console.log('üß™ Test cotejo bajo ejecutado');
        }
        
        // Simular datos de cotejo con error
        function testCotejoError() {
            const resultado = {
                success: false,
                enlaces_automaticos: 0,
                sugerencias: 0,
                requiere_revision: 0,
                notificacion: {
                    tipo: "error",
                    mensaje: "üö® ERROR EN EL COTEJO\n" +
                              "‚ùå No se pudo completar el cotejo\n" +
                              "üîç Verificar la conexi√≥n y los datos",
                    acciones_disponibles: ["verificar_id", "contactar_soporte"]
                }
            };
            
            mostrarPanelResultadosCotejo(resultado);
            console.log('üß™ Test cotejo error ejecutado');
        }
        
        // Funci√≥n para mostrar el panel (simulada)
        function mostrarPanelResultadosCotejo(resultado) {
            const { notificacion, enlaces_automaticos, sugerencias, requiere_revision } = resultado
            
            // Crear o actualizar el panel de resultados
            let panel = document.getElementById('cotejo-resultados-panel')
            if (!panel) {
                panel = document.createElement('div')
                panel.id = 'cotejo-resultados-panel'
                panel.className = 'cotejo-resultados-panel'
                document.body.appendChild(panel)
            }
            
            // Generar contenido del panel
            const contenido = `
                <div class="cotejo-panel-header">
                    <h3>üéØ Resultados del Cotejo Inteligente</h3>
                    <button class="close-panel-btn" onclick="cerrarPanelCotejo()">√ó</button>
                </div>
                
                <div class="cotejo-panel-content">
                    <div class="cotejo-status ${notificacion.tipo}">
                        <div class="status-icon">
                            ${getStatusIcon(notificacion.tipo)}
                        </div>
                        <div class="status-info">
                            <h4>${getStatusTitle(notificacion.tipo)}</h4>
                            <p>${notificacion.mensaje}</p>
                        </div>
                    </div>
                    
                    <div class="cotejo-metrics">
                        <div class="metric-card">
                            <div class="metric-icon">üîó</div>
                            <div class="metric-value">${enlaces_automaticos}</div>
                            <div class="metric-label">Enlaces Autom√°ticos</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon">üí°</div>
                            <div class="metric-value">${sugerencias}</div>
                            <div class="metric-label">Sugerencias</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon">‚ö†Ô∏è</div>
                            <div class="metric-value">${requiere_revision}</div>
                            <div class="metric-label">Requiere Revisi√≥n</div>
                        </div>
                    </div>
                    
                    ${enlaces_automaticos > 0 ? `
                        <div class="cotejo-enlaces-detalle">
                            <h4>üîó Enlaces Creados Autom√°ticamente</h4>
                            <div class="enlaces-grid" id="enlaces-grid">
                                <div class="enlace-loading">üîÑ Cargando detalles de enlaces...</div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="cotejo-actions">
                        ${notificacion.acciones_disponibles.map(accion => 
                            `<button class="btn-accion-cotejo" onclick="ejecutarAccionCotejo('${accion}')">${getActionLabel(accion)}</button>`
                        ).join('')}
                    </div>
                </div>
            `
            
            panel.innerHTML = contenido
            panel.style.display = 'block'
            
            // Si hay enlaces autom√°ticos, cargar los detalles simulados
            if (enlaces_automaticos > 0) {
                setTimeout(() => {
                    cargarEnlacesSimulados(enlaces_automaticos)
                }, 1000)
            }
            
            // Auto-ocultar despu√©s de 15 segundos
            setTimeout(() => {
                if (panel.style.display === 'block') {
                    cerrarPanelCotejo()
                }
            }, 15000)
        }
        
        // üÜï Funci√≥n para cargar enlaces simulados
        function cargarEnlacesSimulados(cantidad) {
            const enlacesGrid = document.getElementById('enlaces-grid')
            if (!enlacesGrid) return
            
            // Simular enlaces de cotejo inverso (Albar√°n -> Facturas)
            const enlacesSimulados = []
            
            for (let i = 1; i <= cantidad; i++) {
                enlacesSimulados.push({
                    id: `enlace-${i}`,
                    datos_extraidos_facturas: {
                        numero_factura: `FAC-2025-${String(i).padStart(3, '0')}`,
                        proveedor_nombre: 'TIERRA NUESTRA HUELVA CONSTANTIN BECERRA, S.L.',
                        fecha_factura: new Date(2025, 7, 15 + i).toISOString(),
                        total_factura: 150.50 + (i * 25.30),
                        importe_neto: 120.00 + (i * 20.00),
                        iva: 30.50 + (i * 5.30)
                    },
                    fecha_cotejo: new Date().toISOString()
                })
            }
            
            // Mostrar los enlaces simulados
            mostrarEnlacesSimuladosEnPanel(enlacesSimulados)
        }
        
        // üÜï Funci√≥n para mostrar enlaces simulados
        function mostrarEnlacesSimuladosEnPanel(enlaces) {
            const enlacesGrid = document.getElementById('enlaces-grid')
            if (!enlacesGrid) return
            
            const enlacesHTML = enlaces.map((enlace, index) => {
                const factura = enlace.datos_extraidos_facturas
                return `
                    <div class="enlace-card enlace-inverso">
                        <div class="enlace-header">
                            <span class="enlace-tipo">üìÑ FACTURA ENLAZADA</span>
                            <span class="enlace-confianza alta">üéØ 100%</span>
                        </div>
                        <div class="enlace-content">
                            <div class="enlace-info">
                                <strong>N√∫mero:</strong> ${factura.numero_factura}
                            </div>
                            <div class="enlace-info">
                                <strong>Proveedor:</strong> ${factura.proveedor_nombre}
                            </div>
                            <div class="enlace-info">
                                <strong>Fecha:</strong> ${formatearFecha(factura.fecha_factura)}
                            </div>
                            <div class="enlace-info">
                                <strong>Total:</strong> ${formatearMoneda(factura.total_factura)}
                            </div>
                        </div>
                        <div class="enlace-metadata">
                            <span class="metodo-enlace">‚è∞ Proximidad Temporal</span>
                            <span class="fecha-cotejo">${formatearFecha(enlace.fecha_cotejo)}</span>
                        </div>
                    </div>
                `
            }).join('')
            
            enlacesGrid.innerHTML = enlacesHTML
        }
        
        // üÜï Funciones auxiliares para formateo
        function formatearFecha(fecha) {
            if (!fecha) return 'N/A'
            try {
                return new Date(fecha).toLocaleDateString('es-ES')
            } catch (error) {
                return fecha
            }
        }
        
        function formatearMoneda(valor) {
            if (!valor) return 'N/A'
            try {
                return new Intl.NumberFormat('es-ES', {
                    style: 'currency',
                    currency: 'EUR'
                }).format(valor)
            } catch (error) {
                return valor
            }
        }
        
        // Funciones auxiliares
        function getStatusIcon(tipo) {
            const icons = {
                'alta_confianza': '‚úÖ',
                'media_confianza': '‚ö†Ô∏è',
                'baja_confianza': '‚ùå',
                'error': 'üö®'
            }
            return icons[tipo] || '‚ÑπÔ∏è'
        }
        
        function getStatusTitle(tipo) {
            const titles = {
                'alta_confianza': 'Cotejo Exitoso',
                'media_confianza': 'Cotejo Parcial',
                'baja_confianza': 'Cotejo Bajo',
                'error': 'Error en Cotejo'
            }
            return titles[tipo] || 'Informaci√≥n'
        }
        
        function getActionLabel(accion) {
            const labels = {
                'ver_enlaces': 'üîó Ver Enlaces',
                'revisar_detalles': 'üìã Revisar Detalles',
                'verificar_id': 'üîç Verificar ID',
                'contactar_soporte': 'üìû Contactar Soporte'
            }
            return labels[accion] || accion
        }
        
        function cerrarPanelCotejo() {
            const panel = document.getElementById('cotejo-resultados-panel')
            if (panel) {
                panel.style.display = 'none'
            }
        }
        
        function ejecutarAccionCotejo(accion) {
            console.log('üîß Ejecutando acci√≥n del cotejo:', accion)
            alert(`Acci√≥n ejecutada: ${accion}`)
        }
    </script>
</body>
</html>
